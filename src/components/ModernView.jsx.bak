import Input from "./Input";
import { renderMarkdown } from "../utils/markdown";

export default function ModernView({
  chats,
  activeChatId,
  onSelectChat,
  onCreateChat,
  onRenameChat,
  onTogglePinChat,
  onDeleteChat,
  theme,
  onToggleTheme,
  models,
  modelsLoading,
  modelsError,
  selectedModel,
  onModelChange,
  isStreaming,
  onStop,
  activeChat,
  onSend,
  undoToast,
  onUndo,
}) {
  const sorted = [...chats].sort((a, b) => (a.pinned === b.pinned ? 0 : a.pinned ? -1 : 1));
  const active = sorted.find((c) => c.id === activeChatId);

  return (
    <div className={`modern-layout ${theme === "light" ? "light" : "dark"}`}>
      <div className="modern-bg">
        <div className="glass-blob blob1" />
        <div className="glass-blob blob2" />
        <div className="glass-blob blob3" />
      </div>

      <header className="modern-header glass">
        <div className="brand">
          <div className="brand-mark">‚óé</div>
          <div>
            <div className="brand-name">Chatbot x ChatMock</div>
            <div className="brand-sub">Liquid Glass UI</div>
          </div>
        </div>

        <div className="header-actions">
          <button className="chip" onClick={onCreateChat}>
            + –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
          </button>
          <button className="chip" onClick={onToggleTheme}>
            –¢–µ–º–∞: {theme === "dark" ? "Dark" : "Light"}
          </button>
          <div className="chip model-chip">
            <span>–ú–æ–¥–µ–ª—å</span>
            <select
              value={selectedModel}
              onChange={(e) => onModelChange(e.target.value)}
              disabled={modelsLoading}
              className={theme === "light" ? "select-light" : ""}
            >
              {models.map((m) => (
                <option key={m} value={m}>
                  {m}
                </option>
              ))}
            </select>
          </div>
          {modelsLoading && <span className="chip subtle">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏‚Ä¶</span>}
          {modelsError && <span className="chip danger">{modelsError}</span>}
          {isStreaming ? (
            <button className="chip danger" onClick={onStop}>
              ‚èπ –°—Ç–æ–ø
            </button>
          ) : (
            <span className="chip subtle">–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞—Ç—å</span>
          )}
        </div>
      </header>

      <div className="modern-grid">
        <aside className="modern-sidebar glass">
          <div className="sidebar-title">–î–∏–∞–ª–æ–≥–∏</div>
          <div className="chat-list">
            {sorted.map((chat) => (
              <div
                key={chat.id}
                className={`chat-pill ${chat.id === activeChatId ? "active" : ""}`}
                onClick={() => onSelectChat(chat.id)}
              >
                <div className="chat-pill-header">
                  <span className="chat-pill-name">{chat.name || "–ë–µ–∑ –∏–º–µ–Ω–∏"}</span>
                  <div className="chat-pill-actions">
                    <button
                      title="–ü–∏–Ω"
                      className={`pill-btn ${chat.pinned ? "accent" : ""}`}
                      onClick={(e) => {
                        e.stopPropagation();
                        onTogglePinChat(chat.id);
                      }}
                    >
                      üìå
                    </button>
                    <button
                      title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å"
                      className="pill-btn"
                      onClick={(e) => {
                        e.stopPropagation();
                        const next = prompt("–ù–æ–≤–æ–µ –∏–º—è", chat.name || "");
                        if (next && next.trim()) onRenameChat(chat.id, next.trim());
                      }}
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      title="–£–¥–∞–ª–∏—Ç—å"
                      className="pill-btn danger"
                      onClick={(e) => {
                        e.stopPropagation();
                        onDeleteChat(chat.id);
                      }}
                    >
                      ‚úñ
                    </button>
                  </div>
                </div>
                <div className="chat-pill-sub">
                  {chat.messages.length ? `${chat.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π` : "–ü—É—Å—Ç–æ"}
                </div>
              </div>
            ))}
          </div>
        </aside>

        <main className="modern-chat glass">
          <div className="modern-chat-header">
            <div>
              <div className="chat-title">{active?.name || "–ù–æ–≤—ã–π —á–∞—Ç"}</div>
              <div className="chat-sub">
                {selectedModel} ‚Ä¢ {isStreaming ? "–°—Ç—Ä–∏–º–∏–º‚Ä¶" : "–ì–æ—Ç–æ–≤"}
              </div>
            </div>
            <div className="pulse-dot" aria-hidden />
          </div>

          <div className="modern-messages">
            {!active || active.messages.length === 0 ? (
              <div className="modern-empty">
                <div className="orbit">
                  <div className="planet" />
                  <div className="satellite" />
                </div>
                <h3>–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å</h3>
                <p>ChatMock –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ç—Ä–∏–º–æ–º. –ù–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
              </div>
            ) : (
              active.messages.map((msg) => (
                <ModernMessage key={msg.id} {...msg} />
              ))
            )}
          </div>

          <div className="modern-input">
            <Input onSend={onSend} isStreaming={isStreaming} onStop={onStop} />
          </div>
        </main>
      </div>

      {undoToast && (
        <div className="modern-toast glass">
          <span>–ß–∞—Ç —É–¥–∞–ª–µ–Ω</span>
          <button onClick={onUndo}>–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
      )}
    </div>
  );
}

function ModernMessage({ sender, type, content, pending, error }) {
  const isUser = sender === "user";
  const renderContent = () => {
    if (type === "text") {
      return (
        <div
          className="bubble-text"
          dangerouslySetInnerHTML={{ __html: renderMarkdown(content) }}
        />
      );
    }

  return (
    <div className={`modern-bubble ${isUser ? "user" : "bot"} ${pending ? "pending" : ""}`}>
      if (type === "image") {
        return <img src={content} alt="attachment" className="bubble-image" />;
      }

      if (type === "images" && Array.isArray(content)) {
        return (
          <div className="bubble-images">
            {content.map((img, i) => (
              <img key={i} src={img} alt={`attachment-${i}`} className="bubble-image" />
            ))}
          </div>
        );
      }

      if (type === "mixed" && content) {
        return (
          <div className="bubble-mixed">
            {content.text && (
              <div
                className="bubble-text"
                dangerouslySetInnerHTML={{ __html: renderMarkdown(content.text) }}
              />
            )}
            {content.image && (
              <img src={content.image} alt="attachment" className="bubble-image" />
            )}
            {content.images &&
              content.images.map((img, i) => (
                <img key={i} src={img} alt={`attachment-${i}`} className="bubble-image" />
              ))}
          </div>
        );
      }

      return null;
    };

      {renderContent()}
      {pending && <span className="bubble-status">¬∑¬∑¬∑</span>}
      {error && <span className="bubble-status error">–û—à–∏–±–∫–∞</span>}
    </div>
  );
}

